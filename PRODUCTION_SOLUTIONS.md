# Решения проблемы с Instagram на проде

## Проблема

Instagram недоступен с продакшн сервера из-за блокировки серверных IP.

## Решения (от простого к сложному)

### ✅ Решение 1: VPN на сервере (РЕКОМЕНДУЕТСЯ)

**Плюсы:**
- Быстро настроить
- Работает сразу
- Не нужно менять код

**Минусы:**
- Зависимость от VPN провайдера
- Дополнительная latency
- Стоимость VPN

**Как:**
1. Настроить VPN на сервере (см. PRODUCTION_VPN_SETUP.md)
2. Перезапустить Docker контейнеры
3. Проверить: `docker exec -it instagram_cf_app curl https://www.instagram.com`

**Стоимость:** $5-15/месяц (VPN подписка)

---

### ✅ Решение 2: Использовать только прокси (через VPN соединение к прокси)

**Плюсы:**
- Прокси уже есть
- Изоляция аккаунтов

**Минусы:**
- Нужен VPN для подключения к прокси (не решает проблему полностью)

**Как:**
1. VPN всё равно нужен (см. Решение 1)
2. Прокси работают через VPN туннель

---

### ✅ Решение 3: Переехать на другой сервер/провайдера

**Плюсы:**
- Нет зависимости от VPN
- Стабильнее

**Минусы:**
- Долго (миграция)
- Риск, что новый IP тоже заблокируют

**Рекомендации:**
- **Residential hosting** (не дата-центр)
- **AWS/GCP/Azure** (обычно не блокируют)
- **Проверить перед миграцией:** зайти на сервер через SSH и проверить `curl https://www.instagram.com`

**Провайдеры с хорошей репутацией:**
- Hetzner Cloud (Германия)
- DigitalOcean (выбрать правильный регион)
- AWS Lightsail
- Linode

---

### ✅ Решение 4: Proxy server на отдельном сервере с доступом к Instagram

**Схема:**
```
Прод сервер -> Ваш proxy server (с VPN) -> Instagram
```

**Как:**
1. Поднять дешевый VPS с VPN
2. Настроить Squid/Nginx proxy
3. В коде использовать этот proxy для всех Instagram запросов

**Плюсы:**
- Централизованное решение
- Можно использовать для всех серверов

**Минусы:**
- Дополнительный сервер ($5-10/месяц)
- Нужно настраивать и поддерживать

---

### ✅ Решение 5: Split-tunneling (только Instagram через VPN)

**Как:**
```bash
# Получить все IP Instagram
nslookup www.instagram.com
nslookup i.instagram.com

# Добавить маршруты только для Instagram через VPN
sudo ip route add 157.240.0.0/16 via <VPN_GATEWAY> dev tun0
sudo ip route add 31.13.0.0/16 via <VPN_GATEWAY> dev tun0
```

**Плюсы:**
- Минимальная latency (остальной трафик идет напрямую)
- Меньше нагрузки на VPN

**Минусы:**
- Сложнее настроить
- Нужно знать все IP Instagram

---

## Рекомендация

**Для быстрого запуска:**
1. Настроить VPN на проде (Решение 1)
2. Настроить автозапуск и мониторинг VPN
3. Использовать прокси для изоляции аккаунтов

**Для долгосрочной стабильности:**
1. Мигрировать на другого провайдера (Решение 3)
2. Проверить доступность Instagram ПЕРЕД миграцией
3. Выбрать residential hosting или AWS/GCP

---

## Быстрый старт (сейчас)

```bash
# 1. На проде включить VPN
# (как вы сделали на dev сервере)

# 2. Проверить доступ к Instagram
curl https://www.instagram.com

# 3. Перезапустить Docker
cd /path/to/instagram_cf
docker-compose down
docker-compose up -d

# 4. Проверить в контейнере
docker exec -it instagram_cf_app curl https://www.instagram.com

# 5. Попробовать авторизацию через интерфейс
```

---

## Мониторинг

После настройки VPN добавить в мониторинг:

```bash
# Проверка доступности Instagram
*/5 * * * * curl -s -o /dev/null -w "%{http_code}" https://www.instagram.com > /tmp/instagram_check.log || echo "Instagram недоступен" | mail -s "ALERT: Instagram down" admin@example.com
```

Добавить в Sentry/логи:
- Проверка VPN IP при старте сервиса
- Алерт, если IP изменился


