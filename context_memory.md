# Context Memory

## 2025-12-03

### Q: Что знаешь о контент-заводах на примере Instagram?

**A:** Контент-заводы = индустриальный подход:
- 5-15 человек → 50-200 постов/день
- 1 день съёмки = 30-60 постов
- A/B тестинг каждого элемента
- Первые 30 мин решают всё
- CTR >15% = алгоритм продвигает
- Стоимость 1 рилса: $5-20
- ROI 300-500%
- Звёзды B/C уровня: $10-50K/мес

**Связь с проектом:** AI-двойники = контент-завод на стероидах. Убирает узкое горлышко физической съёмки. 5 мин/день звезды достаточно для масштабирования.

---

### Q: Задача — сделать контент-завод для Instagram. Написать ТЗ.

**Требования:**
- Постить один пост на множество Instagram-страниц
- Автоматический перевод текста под язык аудитории
- Страницы группируются (IT, Финансы, Новости)
- Каждая страница → свой язык

**Решение (ТЗ создано в TZ.md):**
- **Стек:** FastAPI + PostgreSQL + Celery + Redis + instagrapi
- **Прокси:** 1 аккаунт = 1 residential прокси (защита от банов)
- **Переводы:** DeepL API + кэширование
- **Анти-бан система:**
  - Задержки: 2-5 мин между постами на разные аккаунты
  - Лимиты: макс 10 постов/день с аккаунта
  - Прогрев новых аккаунтов: 3 дня × 1-2 поста
  - Cooldown при достижении лимитов
- **Очередь:** Celery с приоритетами + retry при ошибках
- **БД:** accounts, groups, posts, post_executions, proxies, translations_cache
- **Безопасность:** Шифрование паролей + JWT для админки
- **Мониторинг:** Dashboard метрик + логи всех действий

**План:** 19-28 дней разработки (8 этапов)

**Файлы:** TZ.md (полное ТЗ), context_memory.md (этот файл)

---

### Q: Приступаем к выполнению ТЗ

**Выполнено (Этап 1 - Основа):**
- ✅ Структура проекта создана
- ✅ FastAPI приложение настроено
- ✅ Все модели БД созданы (8 таблиц)
- ✅ Alembic настроен для миграций
- ✅ Pydantic схемы для валидации
- ✅ CRUD API для групп и аккаунтов
- ✅ Система шифрования (Fernet для паролей)
- ✅ Docker Compose конфигурация
- ✅ README.md с инструкциями

**Стек:**
- FastAPI + SQLAlchemy 2.0 + Alembic
- PostgreSQL + Redis
- Docker Compose для разработки

**Следующий этап:** Интеграция instagrapi для работы с Instagram API

---

### Q: Продолжай (Этап 2)

**Выполнено:**
- ✅ Сервис InstagramService создан (авторизация, постинг, проверка статуса)
- ✅ Обработка всех типов ошибок Instagram (баны, rate limits, 2FA, challenge)
- ✅ Система логирования действий в БД
- ✅ API endpoints для постов (создание, загрузка медиа, тестовая публикация)
- ✅ Полная реализация авторизации через Instagram
- ✅ Проверка статуса аккаунта через Instagram API
- ✅ Поддержка прокси для каждого аккаунта

**Следующий этап:** Проксирование (CRUD для прокси, проверка работоспособности, ротация)

---

### Q: Продолжай (Этап 3)

**Выполнено:**
- ✅ Сервис ProxyManager (проверка, назначение, ротация прокси)
- ✅ CRUD API endpoints для прокси
- ✅ Автоматическое назначение прокси при создании аккаунта
- ✅ Автоматическая ротация прокси при ошибках
- ✅ Система метрик прокси (success_rate, статусы)
- ✅ Балансировка нагрузки (прокси с минимальным количеством аккаунтов)

**Следующий этап:** Переводы (DeepL/Google Translate API, кэширование)

---

### Q: Продолжаем разработку. Переводы через DeepSeek API

**Выполнено (Этап 4):**
- ✅ Сервис TranslatorService с DeepSeek API (OpenAI-совместимый)
- ✅ Поддержка 20+ языков с маппингом кодов
- ✅ Кэширование переводов в БД (таблица translations_cache)
- ✅ API endpoints: /api/translations/ (одиночный и пакетный перевод)
- ✅ Интеграция в API постов: POST /api/posts/{id}/translate
- ✅ Сохранение эмодзи и форматирования при переводе
- ✅ Обновлён requirements.txt (openai библиотека)

**Особенности:**
- Использует модель deepseek-chat
- Температура 0.3 для точности
- Автоматический кэш в БД
- При ошибках возвращается оригинальный текст

**Следующий этап:** Система постинга (Celery задачи, массовая публикация, очереди)

---

### Q: Продолжаем разработку (Этап 5)

**Выполнено:**
- ✅ Celery приложение настроено (Redis как брокер)
- ✅ Задача task_post_to_instagram (публикация на один аккаунт):
  - Проверка лимитов и статусов
  - Задержка 30 мин между постами
  - Retry с экспоненциальной задержкой
- ✅ Задача task_batch_post (массовая публикация):
  - Автоматический перевод для каждого языка
  - Случайные задержки 2-5 мин между аккаунтами
  - Создание PostExecution записей
- ✅ API endpoint /api/posts/{id}/publish запускает Celery задачи
- ✅ Улучшён endpoint /api/posts/{id}/executions со статистикой
- ✅ Обновлён docker-compose.yml для Celery worker

**Следующий этап:** Защита от банов (лимиты, прогрев аккаунтов, cooldown)

---

### Q: Пропустить этап прогрева, создать фронтенд

**Выполнено:**
- ✅ React + Vite фронтенд приложение
- ✅ 5 страниц: Dashboard, Accounts, Groups, Posts, Proxies
- ✅ Полный CRUD для всех сущностей
- ✅ Загрузка медиа для постов (drag & drop)
- ✅ Автоматическое обновление статусов
- ✅ Современный UI с Tailwind CSS
- ✅ React Query для кэширования и обновления данных
- ✅ Адаптивный дизайн

**Стек:** React 18, Vite, React Router, React Query, Tailwind CSS, Axios, Lucide Icons

**Готово к использованию!**

---

### Q: Переместить весь backend в папку backend/

**Выполнено:**
- ✅ Перемещены все файлы: app/, alembic/, static/ → backend/
- ✅ Обновлены docker-compose.yml, Dockerfile с новыми путями
- ✅ Обновлён alembic.ini и env.py для работы с новой структурой
- ✅ Обновлён README.md с инструкциями
- ✅ Настроен PYTHONPATH для корректной работы импортов

**Новая структура:**
```
instagram_cf/
├── backend/
│   ├── app/          # FastAPI приложение
│   ├── alembic/      # Миграции БД
│   ├── static/       # Загруженные медиа
│   └── alembic.ini
├── docker-compose.yml
├── Dockerfile
└── requirements.txt
```

