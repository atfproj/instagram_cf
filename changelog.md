# Changelog

## [21.12.2025] - Исправление проблемы с Docker портами

### Исправлено
- **Проблема с пробросом портов Docker:**
  - Бэкенд не отвечал через порт 8009 (Empty reply from server)
  - Причина: монтирование `volumes: - .:/app` вызывало постоянные перезапуски uvicorn
  - Решение: убрали `- .:/app` из volumes, оставили только `uploads_data`
  - Почистили Docker cache (37.75GB)
- **Результат:**
  - ✅ Бэкенд работает на `http://localhost:8009`
  - ✅ Фронтенд работает на `http://localhost:3001`

## [25.12.2025] - Исправление портов для локальной разработки

### Исправлено
- **Проблема с портами фронтенда:**
  - Исправлено несоответствие портов: vite запускался на 3002, а docker-compose пробрасывал 3001
  - Обновлён `docker-compose.yml`: порт изменён с `3001:3001` на `3002:3002`
  - Обновлён `frontend/vite.config.js`: порт изменён с 3001 на 3002
  - Обновлён `frontend/Dockerfile`: EXPOSE изменён с 3001 на 3002
  - Фронтенд теперь доступен на `http://localhost:3002`
  - Бэкенд доступен на `http://localhost:8009`

## [19.12.2025] - Импорт сессий через UI

### Добавлено
- **UI для импорта сессий:**
  - Новая кнопка "Загрузка сессии" на странице аккаунтов
  - Модальное окно `ImportSessionModal` для вставки данных сессии
  - Поддержка форматов 2022-2025 года
  - Выбор группы и прокси при импорте
  - Опциональная валидация сессии
- **Новый сервис `session_importer.py`:**
  - Парсинг строк формата: `username:password|UA|device_ids|cookies||email`
  - Создание `session_data` для instagrapi
  - Валидация импортированных сессий
- **API endpoint:**
  - `POST /api/accounts/import-session-from-text` - импорт через текстовую строку
- **Обновления UI:**
  - Кнопка логина переименована в "Авторизация по логин/пароль"
  - Добавлена иконка `Upload` для загрузки сессий

### Преимущества
- ✅ Обход проверок Instagram (email/SMS) через готовые сессии
- ✅ Быстрый импорт купленных аккаунтов (просто вставить строку)
- ✅ Поддержка всех форматов файлов аккаунтов

## [Unreleased]

### Импорт сессий Instagram из браузера

### Добавлено
- **Сервис импорта сессий (`AccountImporter`):**
  - Парсинг данных аккаунтов из файла формата: `username:password|user_agent|device_ids|cookies||`
  - Преобразование cookies и device IDs в формат `instagrapi` session_data
  - Валидация импортированных сессий через Instagram API
- **API endpoints для импорта сессий:**
  - `POST /api/accounts/{account_id}/import-session` - импорт сессии для одного аккаунта
  - `POST /api/accounts/bulk-import` - массовый импорт аккаунтов из файла
- **Инструкция `HOW_TO_EXPORT_COOKIES.md`:**
  - Как экспортировать свежие cookies из браузера (Chrome/Firefox)
  - Формат данных для импорта
  - Альтернативные способы экспорта (расширения, JavaScript)

### Исправлено
- **Проблема с авторизацией новых аккаунтов через прокси:**
  - Instagram блокирует автоматизированные запросы через прокси (Python/instagrapi)
  - Решение: использование готовых сессий (cookies) из браузера
  - Сессии должны быть свежими (экспортированы сразу после авторизации)

### Технические детали
- Instagram определяет автоматизированные запросы по TLS fingerprint и HTTP-версии
- Браузер использует HTTP/2/3, Python/instagrapi - HTTP/1.1
- Прокси работает в браузере, но не работает в автоматизированных скриптах
- Импорт сессий позволяет обойти блокировку автоматизированных запросов

---

### Детали публикации постов

### Добавлено
- **Расширенная информация о публикациях в деталях поста:**
  - Список опубликованных аккаунтов (статус SUCCESS) с username и коротким текстом
  - Список аккаунтов в очереди (статус QUEUED) с username и коротким текстом
  - Список публикующихся аккаунтов (статус POSTING)
  - Список аккаунтов с ошибками (статус FAILED) с сообщением об ошибке
  - Tooltip при наведении на текст показывает полный текст поста
  - Отображение даты публикации для успешных постов
- **Обновлён API endpoint `/api/posts/{id}/executions`:**
  - Теперь возвращает username аккаунта вместе с execution
  - Возвращает структурированные данные: `executions` и `statistics`
  - Подсчитывает статистику по статусам автоматически

### Улучшено
- Улучшена визуализация статусов публикации (цветовая индикация)
- Добавлена прокрутка для длинных списков аккаунтов
- Улучшена читаемость информации о публикациях

---

### Персонализация постов

### Добавлено
- **Унификация и персонализация текста постов:**
  - Автоматическое перефразирование текста для аккаунтов с одинаковым языком
  - Сохранение хештегов при персонализации
  - Метод `paraphrase` в `TranslatorService` для создания вариаций текста
  - Интеграция персонализации в `task_batch_post` для групповых публикаций
- **Вспомогательные функции:**
  - `_extract_hashtags` - извлечение хештегов из текста
  - `_restore_hashtags` - восстановление хештегов в тексте
- **Логика персонализации:**
  - Если в группе несколько аккаунтов с одинаковым языком, для каждого создаётся уникальная вариация текста
  - Используется DeepSeek API с увеличенной температурой (0.5-0.8) для вариативности
  - Хештеги сохраняются неизменными в конце текста

### Улучшено
- Улучшена уникальность контента при публикации на несколько аккаунтов с одинаковым языком
- Снижен риск обнаружения дублированного контента Instagram алгоритмами

---

### Подготовка к продакшену

### Добавлено
- **Production конфигурация Docker:**
  - `docker-compose.prod.yml` - production-ready конфигурация
  - Убран `--reload` флаг из uvicorn
  - Настроены health checks для всех сервисов
  - Добавлен `restart: unless-stopped` для всех сервисов
  - Production build для фронтенда через nginx
- **Безопасность:**
  - Настройка CORS через переменные окружения (`CORS_ORIGINS`)
  - Отключение Swagger/ReDoc в продакшене (только при `DEBUG=True`)
  - Скрипт `generate_keys.py` для генерации безопасных ключей
  - Файл `env.example` с документацией всех переменных окружения
- **Документация:**
  - `PRODUCTION_READINESS.md` - детальная оценка готовности к продакшену
  - `DEPLOY.md` - инструкция по деплою на продакшен
  - Обновлён `README.md` с инструкциями

### Исправлено
- Исправлена минимальная задержка между постами (используется `MIN_DELAY_BETWEEN_POSTS_SEC` из настроек)
- Улучшена обработка изображений (автоматическая конвертация в JPG и изменение соотношения сторон)
- Исправлена валидация ответов API (использование `from_orm` для Pydantic v1)
- Улучшено управление прокси (выбор из списка доступных, отвязка прокси)

### Улучшено
- Автоматическая конвертация изображений в JPG перед публикацией
- Автоматическое изменение соотношения сторон изображений (4:5 или 1.91:1)
- Улучшенное логирование процесса публикации
- Проверка доступности Instagram через прокси при валидации

---

### Frontend: Веб-интерфейс

### Добавлено
- React + Vite фронтенд приложение:
  - Современный UI с Tailwind CSS
  - Адаптивный дизайн (mobile-friendly)
  - React Router для навигации
  - React Query для управления состоянием
- Страницы:
  - Dashboard - общая статистика и обзор системы
  - Accounts - управление Instagram аккаунтами (CRUD, авторизация, проверка статуса)
  - Groups - управление группами аккаунтов
  - Posts - создание постов с загрузкой медиа, публикация, просмотр статуса
  - Proxies - управление прокси серверами (CRUD, проверка работоспособности)
- Компоненты:
  - Layout с боковой навигацией
  - Modal для форм
  - Формы для создания/редактирования (AccountForm, GroupForm, PostForm, ProxyForm)
  - Бейджи статусов с иконками
- API интеграция:
  - Axios клиент с обработкой ошибок
  - API модули для всех сущностей
  - Автоматическое обновление данных через React Query
- Особенности:
  - Drag & drop загрузка файлов для постов
  - Автоматическое обновление статуса публикации постов
  - Валидация форм
  - Подтверждение опасных действий

---

### Этап 5: Система постинга (Celery)

### Добавлено
- Celery приложение для асинхронной обработки задач:
  - Конфигурация Celery с Redis как брокером
  - Настройки таймаутов, retry, приоритетов
- Celery задачи:
  - `task_post_to_instagram` - публикация поста на один аккаунт:
    - Проверка лимитов и статуса аккаунта
    - Минимальная задержка 30 минут между постами с одного аккаунта
    - Автоматический retry при ошибках (макс 3 попытки)
    - Экспоненциальная задержка между retry
    - Обработка всех типов ошибок Instagram
  - `task_batch_post` - массовая публикация:
    - Создание задач для каждого аккаунта в группах
    - Автоматический перевод текста для каждого языка
    - Случайные задержки между публикациями (2-5 минут)
    - Создание записей PostExecution для отслеживания
- Обновлён API endpoint публикации:
  - POST /api/posts/{id}/publish - запускает Celery задачу
  - Возвращает task_id для отслеживания
- Улучшён endpoint статуса публикации:
  - GET /api/posts/{id}/executions - возвращает статистику по статусам
- Обновлён docker-compose.yml для запуска Celery worker

### Технические детали
- Используется DatabaseTask для управления сессиями БД в задачах
- Автоматическое закрытие сессий после выполнения задач
- Приоритеты задач: normal (5)
- Максимальное время выполнения задачи: 5 минут
- Worker перезапускается после 50 задач

---

### Этап 4: Переводы (DeepSeek API)

### Добавлено
- Сервис `TranslatorService` для переводов через DeepSeek API:
  - Использование OpenAI-совместимого API DeepSeek
  - Поддержка 20+ языков (en, ru, es, fr, de, it, pt, pl, tr, ar, zh, ja, ko, hi, nl, sv, da, no, fi, cs, uk)
  - Кэширование переводов в БД (таблица `translations_cache`)
  - Пакетный перевод нескольких текстов
  - Сохранение эмодзи, хэштегов и форматирования при переводе
- API endpoints для переводов:
  - POST /api/translations/ - перевести один текст
  - POST /api/translations/batch - перевести несколько текстов
  - GET /api/translations/languages - список поддерживаемых языков
- Интеграция переводов в API постов:
  - POST /api/posts/{id}/translate - получить переводы для всех языков аккаунтов в группах
- Обновлён `requirements.txt`: добавлена библиотека `openai` для работы с DeepSeek API
- Обновлён `.env.example`: добавлены `DEEPSEEK_API_KEY` и `DEEPSEEK_BASE_URL`

### Технические детали
- Используется модель `deepseek-chat` через OpenAI-совместимый интерфейс
- Температура 0.3 для более точных переводов
- Автоматическое кэширование результатов в БД
- При ошибках перевода возвращается оригинальный текст

---

### Рефакторинг структуры проекта

### Изменено
- Весь backend код перемещён в папку `backend/`:
  - `app/` → `backend/app/`
  - `alembic/` → `backend/alembic/`
  - `alembic.ini` → `backend/alembic.ini`
  - `static/` → `backend/static/`
- Обновлены конфигурационные файлы:
  - `docker-compose.yml` - обновлены пути и команды
  - `Dockerfile` - обновлены пути, добавлен PYTHONPATH
  - `backend/alembic.ini` - обновлён prepend_sys_path
  - `backend/alembic/env.py` - обновлены импорты
- Обновлён `README.md` с новыми инструкциями по запуску

---

### Этап 3: Проксирование

### Добавлено
- Сервис `ProxyManager` для управления прокси:
  - Проверка работоспособности прокси через httpx
  - Автоматическое назначение прокси аккаунтам (балансировка нагрузки)
  - Ротация прокси при ошибках
  - Обновление статуса и success_rate прокси
- API endpoints для прокси:
  - POST /api/proxies/ - добавить прокси
  - GET /api/proxies/ - список прокси (с фильтрацией по статусу)
  - GET /api/proxies/{id} - информация о прокси
  - PUT /api/proxies/{id} - обновить прокси
  - DELETE /api/proxies/{id} - удалить прокси (с проверкой использования)
  - POST /api/proxies/{id}/check - проверить работоспособность прокси
  - GET /api/proxies/{id}/accounts - список аккаунтов, использующих прокси
- Pydantic схемы для прокси с валидацией URL
- Автоматическое назначение прокси при создании аккаунта (если не указан)
- Автоматическая ротация прокси при ошибках публикации
- Система метрик прокси (success_rate, last_check_at)

### Улучшено
- При создании аккаунта автоматически назначается свободный прокси
- При ошибках публикации, связанных с прокси, происходит автоматическая ротация
- Балансировка нагрузки: прокси назначается аккаунтам с учётом количества уже назначенных

---

### Этап 2: Instagram интеграция

### Добавлено
- Сервис `InstagramService` для работы с Instagram через instagrapi:
  - Авторизация с сохранением сессий
  - Проверка статуса аккаунта
  - Публикация фото и видео
  - Обработка всех типов ошибок Instagram (баны, rate limits, 2FA)
- Утилита логирования действий (`utils/logging.py`):
  - Автоматическое логирование всех действий в БД
  - Обновление статусов аккаунтов с логированием
- API endpoints для постов:
  - POST /api/posts/ - создание поста с загрузкой медиа
  - GET /api/posts/ - список постов
  - GET /api/posts/{id} - информация о посте
  - POST /api/posts/{id}/publish - запуск публикации (заглушка для Celery)
  - POST /api/posts/{id}/test-post/{account_id} - тестовая публикация на один аккаунт
  - GET /api/posts/{id}/executions - статус публикации
- Обновлены endpoints аккаунтов:
  - POST /api/accounts/{id}/login - полная реализация авторизации
  - GET /api/accounts/{id}/status - проверка статуса через Instagram API
- Поддержка прокси для каждого аккаунта
- Автоматическое сохранение device_id и user_agent при авторизации

### Исправлено
- Упрощена логика шифрования в `security.py`
- Исправлен формат прокси для instagrapi

---

## [Этап 1]

### Добавлено
- Базовая структура проекта (FastAPI + PostgreSQL + Redis + Celery)
- Docker Compose конфигурация для разработки
- SQLAlchemy модели для всех таблиц:
  - `accounts` - аккаунты Instagram
  - `groups` - группы аккаунтов
  - `posts` - посты для публикации
  - `post_executions` - статус публикации по каждому аккаунту
  - `proxies` - пул прокси
  - `translations_cache` - кэш переводов
  - `users` - пользователи админки
  - `activity_logs` - логи всех действий
- Pydantic схемы для валидации данных
- Alembic настроен для миграций БД
- Система шифрования паролей и прокси credentials (Fernet)
- CRUD API endpoints для групп:
  - POST /api/groups/ - создать группу
  - GET /api/groups/ - список групп
  - GET /api/groups/{id} - информация о группе
  - PUT /api/groups/{id} - обновить группу
  - DELETE /api/groups/{id} - удалить группу
  - GET /api/groups/{id}/accounts - аккаунты в группе
- CRUD API endpoints для аккаунтов:
  - POST /api/accounts/ - добавить аккаунт
  - GET /api/accounts/ - список аккаунтов
  - GET /api/accounts/{id} - информация об аккаунте
  - PUT /api/accounts/{id} - обновить аккаунт
  - DELETE /api/accounts/{id} - удалить аккаунт
  - POST /api/accounts/{id}/login - авторизация (заглушка)
  - GET /api/accounts/{id}/status - статус аккаунта

### Технические детали
- Python 3.11+
- FastAPI 0.104.1
- SQLAlchemy 2.0.23
- Alembic 1.12.1
- Pydantic 2.5.0

### Следующие шаги
- Интеграция instagrapi для работы с Instagram
- Реализация авторизации через Instagram
- Система проксирования
- Система переводов (DeepL/Google Translate)
- Celery задачи для массового постинга
- Защита от банов (лимиты, задержки, прогрев)

